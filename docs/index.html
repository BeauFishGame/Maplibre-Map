<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Auckland Waikato Fishing Map</title>
  <link rel="icon" href="images/favicon.png" type="image/png">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />

  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    .map-overlay {
      display: none;
      font: 12px/20px Arial, sans-serif;
      padding: 10px;
      position: absolute;
      right: 0;
      top: 0;
      width: 230px;
      overflow: hidden;
      white-space: normal;
      transition: opacity 0.3s ease;
    }

    .map-overlay-inner {
      position: fixed;
      top: 80px;
      /* distance from the top */
      left: 10px;
      width: 400px;
      height: calc(100vh - 90px);
      /* always stretch to bottom */
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .5);
      z-index: 999;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    .panel-scroll {
      padding-top: 30px;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
      -webkit-overflow-scrolling: touch;
    }

    .map-overlay-inner hr {
      margin: 5px 0;
      border: none;
      border-top: 2px solid #ccc;
    }

    #zoom-level {
      position: absolute;
      bottom: 10px;
      left: 1000px;
      background: rgba(255, 255, 255, 0.8);
      padding: 6px 10px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      border-radius: 4px;
      z-index: 1;
      user-select: none;
      pointer-events: none;
    }

    .card-title {
      font-family: Arial, sans-serif;
      font-size: 25px;
      font-weight: bold;
      color: #2a2a2a;
    }

    .card-list {
      list-style-type: none;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      font-size: 15px;
      padding-left: 0;
      margin: 0;
    }

    .subtitle-main {
      font-size: 1.3em;
      font-weight: bold;
      color: #333;
      margin-top: 4px;
    }

    .directions-inline-image {
      width: 20px;
      height: 20px;
      cursor: pointer;
      opacity: 0.85;
      transition: transform 0.2s, opacity 0.2s;
    }

    .directions-inline-image:hover {
      transform: scale(1.1);
      opacity: 1;
    }

    .subtitle-region {
      font-size: 1.em;
      font-style: italic;
      color: #666;
      margin-bottom: 4px;
    }


    #filter-toggle-btn:hover {
      background-color: #f0f0f0;
    }

    #actions button:active {
      transform: translateY(1px);
    }


    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      background: transparent;
      border: none;
      font-size: 24px;
      color: #333;
      cursor: pointer;
      z-index: 10000;
    }

    #top-bar {
      position: relative;
      height: 70px;
      background-color: rgba(7, 7, 7, 1);
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 10;
    }

    #top-bar .logo {
      height: 70px;
      z-index: 11;
    }



    #search-container input[type="text"] {
      width: 100%;
      padding: 10px 14px;
      font-size: 14px;
      border: none;
      border-radius: 20px;
      background-color: rgba(255, 255, 255, 0.2);
      color: #e7e2e2;
      outline: none;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    #search-container input[type="text"]:focus {
      background-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
    }

    #suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 0 0 20px 20px;
      overflow: hidden;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      z-index: 11;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      border: none;
      font-family: Arial, sans-serif;
    }

    .suggestion {
      padding: 8px 10px;
      font-weight: 200;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
    }

    .suggestion:hover {
      background: #f0f0f0;
    }

    .suggestion-header {
      font-weight: bold;
      font-size: 0.85rem;
      padding: 8px 10px;
      background-color: #f9f9f9;
      color: #444;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-top: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
    }

    .river-header {
      border-left: 4px solid #0072B2;
    }

    .point-header {
      border-left: 4px solid #D55E00;
    }

    .section {
      font-size: 80%;
    }

    .region {
      font-style: italic;
      font-size: 75%;
      color: #888;
    }

    .maplibregl-ctrl-top-right {
      top: 70px;
    }


    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
    }

    .modal.show {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      max-width: 80%;
      max-height: 80%;
      border-radius: 6px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .close-modal {
      position: absolute;
      top: 30px;
      right: 50px;
      color: white;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
    }

    .basemap-btn {
      display: block;
      width: 100%;
      margin-bottom: 8px;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      text-align: left;
      background-color: #e9edf3;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .basemap-btn:hover {
      background-color: #d1d5db;
    }

    .basemap-btn.active {
      background-color: #10b981;
      /* green highlight */
      color: white;
      font-weight: bold;
    }


    #actions button {
      height: 70%;
      /* 70% of top bar height */
      aspect-ratio: 1 / 1;
      /* keep square */
      border-radius: 20%;
      /* proportional rounding */
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      border: none;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    /* Desktop (optional center) */
    #search-container {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 20vw;
      min-width: 200px;
      z-index: 11;
    }

    /* Mobile */
    @media (max-width: 768px) {
      #search-container {
        position: static;
        /* kill absolute centering */
        left: auto;
        transform: none;
        flex: 1 1 auto;
        /* stretch between logo and actions */
        min-width: 0;
        max-width: none;
        margin-right: 30px;
        /* pick ONE value you want */
      }
    }


    @media (max-width: 768px) {
      #top-bar {
        height: 56px;
        padding: 0 10px;
      }

      #top-bar .logo {
        display: none;
      }

      /* your request */
      #search-container {
        flex: 1 1 auto;
      }

      /* search gets the space */

      #actions button {
        width: 44px;
        height: 44px;
        /* bigger tap targets on phones */
        border-radius: 10px;
      }

      #actions button img {
        width: 22px;
        height: 22px;
      }

      /* suggestions list stays attached to the input but won’t run under buttons */
      #suggestions {
        max-height: 45vh;
      }

      /* MapLibre controls away from the bar */
      .maplibregl-ctrl-top-right {
        top: 8px;
      }
    }

    @media (max-width: 768px) {

      /* Move map controls to bottom left on mobile */
      .maplibregl-ctrl-top-right {
        top: auto !important;
        /* cancel top positioning */
        right: auto !important;
        /* cancel right positioning */
        bottom: 10px;
        /* set distance from bottom */
        left: 10px;
        /* set distance from left */
        flex-direction: column;
        /* keep stacked vertically */
      }
    }

    /* Bottom sheet behavior on small screens */
    @media (max-width: 768px) {
      .map-overlay-inner {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 40vh;
        /* bottom sheet height */
        border-radius: 14px 14px 0 0;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
      }

      .panel-scroll {
        padding-top: 36px;
      }

      /* clear the close button */
      .close-button {
        top: 8px;
        right: 12px;
        font-size: 28px;
      }
    }


    @media (max-width: 768px) {

      #filter-toggle-btn,
      #basemap-toggle-btn {
        padding: 12px;
        border-radius: 10px;
      }

      #filter-toggle-btn img,
      #basemap-toggle-btn img {
        width: 24px;
        height: 24px;
      }

    }


    @media (max-width: 768px) {
      .maplibregl-ctrl-bottom-right {
        margin: 0 10px calc(10px + env(safe-area-inset-bottom)) 0;
      }
    }

    @media (max-width: 768px) {
      .map-overlay-inner {
        box-shadow: 0 6px 16px rgba(0, 0, 0, .25);
      }

      .source-card {
        border-radius: 8px;
      }

      .basemap-btn {
        padding: 12px;
      }
    }

    /* Actions area inside the top bar */
    #actions {
      margin-left: auto;
      /* pushes actions to the right */
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #actions #filter-toggle-btn,
    #actions #basemap-toggle-btn {
      position: static;
      /* cancel old absolute positioning */
      right: auto;
      top: auto;
      display: grid;
      place-items: center;
      width: 40px;
      height: 40px;
      padding: 0;
      background: #fff;
      border: none;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    #actions #filter-toggle-btn img,
    #actions #basemap-toggle-btn img {
      width: 20px;
      height: 20px;
      display: block;
    }

    /* Mobile scaling */
    @media (max-width: 768px) {

      #actions #filter-toggle-btn,
      #actions #basemap-toggle-btn {
        width: 44px;
        height: 44px;
        border-radius: 10px;
      }

      #actions #filter-toggle-btn img,
      #actions #basemap-toggle-btn img {
        width: 22px;
        height: 22px;
      }
    }



    @media (max-width: 768px) {
      #top-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        /* nice breathing room */
      }



      #search-container input[type="text"] {
        width: 100%;
        font-size: 16px;
        /* avoid iOS zoom */
      }

      /* The action buttons live inside #actions now; keep them static */
      #actions #filter-toggle-btn,
      #actions #basemap-toggle-btn {
        position: static;
        /* ensure NOT absolute on mobile */
      }
    }
  </style>
</head>

<body>

  <div id="imageModal" class="modal">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="modalImage">
  </div>

  <div id="map"></div>

  <div id="top-bar">
    <a href="https://www.fishandgame.org.nz/" target="_blank">
      <img class="logo" src="images/White%20LS - Copy.png" alt="Logo">
    </a>

    <div id="search-container">
      <input type="text" id="search" placeholder="Search water and points..." autocomplete="off" />
      <div id="suggestions"></div>
    </div>

    <!-- NEW: actions live inside the bar -->
    <div id="actions">
      <button onclick="toggleBasemaps()" id="basemap-toggle-btn" aria-label="Basemaps">
        <img src="images/Layers.svg" alt="">
      </button>
      <button onclick="toggleFilters()" id="filter-toggle-btn" aria-label="Filters">
        <img src="images/Filters.svg" alt="">
      </button>
    </div>
  </div>


  <!-- ========================================================= -->
  <!-- SHOWCARD -->
  <!-- ========================================================= -->

  <div id="combined-filters" style="display:none;">
    <div class="map-overlay-inner">
      <button class="close-button" onclick="closeCard()">&times;</button>

      <div class="panel-scroll">

        <style>
          #combined-filters,
          #combined-filters * {
            font-family: "Arial", sans-serif;
          }

          .filters-body {
            padding: 6px 0 0;
          }

          .source-card {
            background: #f6f7f9;
            border: 1px solid #e2e5ea;
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden
          }

          .source-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 12px;
            background: #e9edf3;
            cursor: pointer
          }

          .source-name {
            font-weight: 700;
            font-size: 13px;
            color: #1f2937
          }

          .source-controls {
            display: flex;
            align-items: center;
            gap: 8px
          }

          .btn {
            appearance: none;
            border: 0;
            border-radius: 8px;
            background: #374151;
            color: #fff;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px
          }

          .btn[aria-pressed="true"] {
            background: #10b981
          }

          .btn.small {
            padding: 4px 8px;
            font-size: 11px
          }

          .source-body {
            display: none;
            padding: 10px 12px;
            background: #fff;
            border-top: 1px solid #e2e5ea
          }

          .group {
            margin-bottom: 12px
          }

          .group-title {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 6px;
            color: #374151
          }

          .option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
            font-size: 12px
          }

          .option input {
            cursor: pointer
          }

          .hint {
            font-size: 11px;
            opacity: .8
          }
        </style>

        <div id="filters-body" class="filters-body">

          <!-- ================= WATERWAY DATA ================= -->
          <div class="source-card" data-source="waterways">
            <div class="source-head">
              <div class="source-name">Waterway Layers (Zoom >7)</div>
              <div class="source-controls">
                <button class="btn toggle-visible" aria-pressed="true" data-source="waterways">Shown</button>
                <button class="btn small toggle-expand" aria-expanded="false">Options ▾</button>
              </div>
            </div>
            <div class="source-body">

              <div class="group" data-group="w-method" data-type="radioOne">
                <div class="group-title">Allowed Method</div>
                <label class="option"><input type="radio" name="w-method" value="__ALL__" checked> ALL</label>
                <label class="option"><input type="radio" name="w-method" value="fly"> Fly</label>
                <label class="option"><input type="radio" name="w-method" value="spin"> Spin</label>
                <label class="option"><input type="radio" name="w-method" value="bait"> Bait</label>
                <label class="option"><input type="radio" name="w-method" value="fly_only"> Fly only</label>
              </div>

              <div class="group" data-group="w-type" data-type="radioOne">
                <div class="group-title">Waterway type</div>
                <label class="option"><input type="radio" name="w-type" value="__ALL__" checked> ALL</label>
                <label class="option"><input type="radio" name="w-type" value="Rivers/streams"> Rivers/streams</label>
                <label class="option"><input type="radio" name="w-type" value="Lakes"> Lakes</label>
                <label class="option"><input type="radio" name="w-type" value="Canals"> Canals</label>
                <label class="option"><input type="radio" name="w-type" value="Ponds"> Ponds</label>
              </div>

              <div class="group" data-group="w-open" data-type="radioOne">
                <div class="group-title">Open</div>
                <label class="option"><input type="radio" name="w-open" value="style_today" checked> Color code by
                  open/closed based on todays date</label>
                <label class="option"><input type="radio" name="w-open" value="filter_today"> Show only waterways open
                  today</label>
              </div>

            <div class="group" data-group="w-fishery" data-type="radioOne">
  <div class="group-title">Fishery type</div>
  <label class="option"><input type="radio" name="w-fishery" value="__ALL__" data-role="all" checked> All</label>
  <label class="option"><input type="radio" name="w-fishery" value="backcountry"> Backcountry</label>
  <label class="option"><input type="radio" name="w-fishery" value="sea_run_salmon"> Sea-run salmon fishery</label>
  <label class="option"><input type="radio" name="w-fishery" value="designated"> Designated water</label>
  <label class="option"><input type="radio" name="w-fishery" value="controlled"> Controlled fishery</label>
  <label class="option"><input type="radio" name="w-fishery" value="junior"> Junior fishery</label>
  <label class="option"><input type="radio" name="w-fishery" value="stocked"> Stocked/put-take fishery</label>
  <label class="option"><input type="radio" name="w-fishery" value="coarse"> Coarse fishery</label>
</div>

<!-- 
              <div class="group" data-group="w-species" data-type="checkboxAny">
                <div class="group-title">Known Species</div>
                <label class="option"><input type="checkbox" data-role="all" checked> All</label>
                <label class="option"><input type="checkbox" value="rainbow_trout" checked> Rainbow Trout</label>
                <label class="option"><input type="checkbox" value="brown_trout" checked> Brown Trout</label>
                <label class="option"><input type="checkbox" value="perch" checked> Perch</label>
                <label class="option"><input type="checkbox" value="tench" checked> Tench</label>
                <label class="option"><input type="checkbox" value="rudd" checked> Rudd</label>
                <label class="option"><input type="checkbox" value="brook_trout" checked> Brook Trout</label>
                <label class="option"><input type="checkbox" value="sockeye_salmon" checked> Sockeye salmon</label>
                <label class="option"><input type="checkbox" value="chinook_salmon" checked> Chinook salmon</label>
              </div> -->
            </div>
          </div>

          <!-- ================= POINT DATA ================= -->
          <div class="source-card" data-source="points">
            <div class="source-head">
              <div class="source-name">Point Layers (Zoom >7)</div>
              <div class="source-controls">
                <button class="btn toggle-visible" aria-pressed="true" data-source="points">Shown</button>
                <button class="btn small toggle-expand" aria-expanded="false">Options ▾</button>
              </div>
            </div>
            <div class="source-body">
              <div class="group" data-group="p-type" data-type="checkboxAny">
                <div class="group-title">Point Type</div>
                <label class="option"><input type="checkbox" data-role="all" checked> Select all</label>

                <!-- Values map to your existing 'point_type' field -->
                <label class="option"><input type="checkbox" value="AccessPoint"
                    data-values='["AccessPoint","Parking","Warning"]' checked> F&amp;G Access</label>
                <label class="option"><input type="checkbox" value="TrampingAccess" checked> F&amp;G Tramping
                  Access</label>
                <label class="option"><input type="checkbox" value="4x4Access" checked> F&amp;G 4x4 Access</label>
                <label class="option"><input type="checkbox" value="BoatRamp" checked> Boat ramp</label>
                <label class="option"><input type="checkbox" value="FlyFishing" checked> Fishing spot - Fly</label>
                <label class="option"><input type="checkbox" value="Jigging" checked> Fishing spot - Jigging</label>
                <label class="option"><input type="checkbox" value="Trolling" checked> Fishing spot - Trolling</label>
                <label class="option"><input type="checkbox" value="Shop" checked> Fly fishing stores</label>
                <label class="option"><input type="checkbox" value="Lodge" checked> Fly fishing lodgees</label>
                <label class="option"><input type="checkbox" value="Hut" checked> DOC Huts</label>
                <label class="option"><input type="checkbox" value="Campsite" checked> DOC Campgrounds</label>
                <label class="option"> <input type="checkbox" value="Beat" data-values='["BeatYR","BeatBY","BeatBR"]'
                    checked> Beat markers </label>

              </div>
            </div>
          </div>

          <!-- ========== PUBLIC ACCESS & PROPERTY LAYERS ========== -->
          <div class="source-card" data-source="publicAccess">
            <div class="source-head">
              <div class="source-name">Public Access &amp; Property Layers (Zoom > 12)</div>
              <div class="source-controls">
                <button class="btn toggle-visible" aria-pressed="true" data-source="publicAccess">Shown</button>
                <button class="btn small toggle-expand" aria-expanded="false">Options ▾</button>
              </div>
            </div>
            <div class="source-body">
              <div class="hint">
                <a href="https://www.herengaanuku.govt.nz/types-of-access" target="_blank">
                  Learn more about legal public access in NZ
                </a>
              </div>
            </div>
          </div>

          <!-- ================= FISH & GAME REGIONS ================= -->
          <div class="source-card" data-source="regions">
            <div class="source-head">
              <div class="source-name">Fish &amp; Game Regions</div>
              <div class="source-controls">
                <button class="btn toggle-visible" aria-pressed="true" data-source="regions">Shown</button>
                <button class="btn small toggle-expand" aria-expanded="false">Options ▾</button>
              </div>
            </div>
            <div class="source-body">
              <div class="hint">Show/Hide toggles outlines + labels together.</div>
            </div>
          </div>

        </div><!-- /filters-body -->

        <script>
          // Expand/collapse UI (no map dependency)
          document.querySelectorAll('#filters-body .toggle-expand').forEach(btn => {
            btn.addEventListener('click', e => {
              const body = e.target.closest('.source-card').querySelector('.source-body');
              const open = body.style.display === 'block';
              body.style.display = open ? 'none' : 'block';
              e.target.setAttribute('aria-expanded', String(!open));
              e.target.textContent = open ? 'Options ▾' : 'Options ▴';
            });
          });

          // “Select all” behavior for multi groups
          document.querySelectorAll('#filters-body .group[data-type="checkboxAny"]').forEach(group => {
            const allBox = group.querySelector('input[data-role="all"]');
            const boxes = Array.from(group.querySelectorAll('input[type="checkbox"]:not([data-role="all"])'));
            if (allBox) {
              allBox.addEventListener('change', () => boxes.forEach(cb => cb.checked = allBox.checked));
              boxes.forEach(cb => {
                cb.addEventListener('change', () => {
                  if (!cb.checked) allBox.checked = false;
                  if (boxes.every(b => b.checked)) allBox.checked = true;
                });
              });
            }
          });

          // Debounce helper to avoid spamming setFilter
          let filterTimer = null;
          function scheduleApply(fn) {
            if (filterTimer) cancelAnimationFrame(filterTimer);
            let t;
            filterTimer = requestAnimationFrame(() => {
              clearTimeout(t);
              t = setTimeout(() => fn(), 120);
            });
          }

          // Expose a function so we can wire MapLibre once the map exists
          window.setupAWFilters = function (map) {
            if (window.__filtersWired) return;
            window.__filtersWired = true;

            const LAYERS = {
              waterways: ['AW Rivers-line', 'AW Rivers-fill'],
              points: ['data-points-all'],
              publicAccess: ['PublicAccessAreas-fill'],
              regions: ['FG Regions-line', 'FG Region Labels']
            };

            const PROPS = {
              waterways: {
                fly: 'fly',
                spin: 'spin',
                bait: 'bait',
                closed: 'permanently_closed',
                open_start: 'open_date_unix',
                open_end: 'close_date_unix',
                type: 'water_type',     // supply when available
                fishery: null,  // supply when available
                species: null   // supply when available
              },
              points: { type: 'point_type' }
            };

            const FISHERY_FIELDS = {
              backcountry: 'backcountry',
              sea_run_salmon: 'searun_salmon_fishery',
              designated: 'designated_water',
              controlled: 'controlled_fishery',
              junior: 'junior_fishery',
              stocked: 'stocked_put_take_fishery',
              coarse: 'coarse_fishery'
            };

            const filtersRoot = document.getElementById('filters-body');

            // Helpers
            const getRadio = (group) => {
              const el = filtersRoot.querySelector(`.group[data-group="${group}"] input[type="radio"]:checked`);
              return el ? el.value : null;
            };
            // Replace your current getChecks() with this version
            const getChecks = (group) => {
              const groupEl = filtersRoot.querySelector(`.group[data-group="${group}"]`);
              if (!groupEl) return null;

              const allBox = groupEl.querySelector('input[data-role="all"]');
              const boxes = [...groupEl.querySelectorAll('input[type="checkbox"]:not([data-role="all"])')];

              // If "Select all" is checked or no boxes at all, treat as ALL
              if ((allBox && allBox.checked) || boxes.length === 0) return null;

              // Gather checked boxes and EXPAND umbrellas with data-values
              const out = [];
              for (const b of boxes) {
                if (!b.checked) continue;

                const dv = b.dataset.values; // e.g. '["BeatYR","BeatBY","BeatBR"]' or "A,B,C"
                if (dv) {
                  try {
                    out.push(...JSON.parse(dv));                    // JSON array
                  } catch {
                    out.push(...dv.split(',').map(s => s.trim()).filter(Boolean)); // CSV fallback
                  }
                } else if (b.value) {
                  out.push(b.value);
                }
              }

              // If none checked, return [] (your caller hides all)
              if (out.length === 0) return [];

              // De-dup for safety
              return [...new Set(out)];
            };

            const setVisibility = (ids, visible) => {
              ids.forEach(id => {
                if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', visible ? 'visible' : 'none');
              });
            };

            // Master show/hide
            document.querySelectorAll('#filters-body .toggle-visible').forEach(btn => {
              btn.addEventListener('click', e => {
                const pressed = e.target.getAttribute('aria-pressed') === 'true';
                const src = e.target.dataset.source;
                e.target.setAttribute('aria-pressed', String(!pressed));
                e.target.textContent = pressed ? 'Hidden' : 'Shown';
                setVisibility(LAYERS[src] || [], !pressed);
              });
            });

            // ====== Filter application with no-op guard ======
            const lastFilters = Object.create(null); // keyed by layerId

            function safeSetFilter(layerId, expr) {
              const json = JSON.stringify(expr);
              if (lastFilters[layerId] === json) return; // no-op for this specific layer
              lastFilters[layerId] = json;
              if (map.getLayer(layerId)) map.setFilter(layerId, expr);
            }

            function applyWaterwayFilters() {
              const m = getRadio('w-method');             // __ALL__, fly, spin, bait, fly_only
              const openMode = getRadio('w-open');        // style_today, filter_today
              const wtype = getRadio('w-type');           // __ALL__, river, lake, canal, pond
              const fishery = getRadio('w-fishery');   // null (all) | [] none | [...]
              const species = getChecks('w-species');     // null (all) | [] none | [...]

              const p = PROPS.waterways;
              const clauses = [];

              if (m && m !== '__ALL__') {
                if (m === 'fly_only') {
                  clauses.push(['all',
                    ['==', ['get', p.fly], 1],
                    ['==', ['get', p.spin], 0],
                    ['==', ['get', p.bait], 0],
                    ['==', ['get', p.closed], 0]
                  ]);
                } else if (['fly', 'spin', 'bait'].includes(m)) {
                  clauses.push(['==', ['get', p[m]], 1]);
                }
              }

              if (wtype && wtype !== '__ALL__' && p.type) {
                clauses.push(['==', ['get', p.type], wtype]);
              }

if (fishery && fishery !== '__ALL__') {
  const field = FISHERY_FIELDS[fishery];
  if (field) {
    // robust to "0"/"1" strings
    clauses.push(['==', ['to-number', ['get', field]], 1]);
  } else {
    // unknown selection → hide all
    clauses.push(['==', ['literal', 1], 2]);
  }
}



              if (species && species.length && p.species) {
                clauses.push(['in', ['get', p.species], ['literal', species]]);
              }

              if (openMode === 'filter_today') {
                const today = window.__TODAY_UNIX__;
                clauses.push(['all',
                  ['<=', ['get', p.open_start], today],
                  ['>=', ['get', p.open_end], today]
                ]);
              }

              const finalExpr = clauses.length ? ['all', ...clauses] : true;
              (LAYERS.waterways || []).forEach(id => safeSetFilter(id, finalExpr));
            }

            function applyPointFilters() {
              const selected = getChecks('p-type'); // null=all; []=none; otherwise list
              let expr = true;
              if (selected === null) {
                expr = true;
              } else if (selected.length === 0) {
                expr = ['==', ['get', 'point_type'], '__NONE__']; // hide all
              } else {
                expr = ['in', ['get', PROPS.points.type], ['literal', selected]];
              }
              (LAYERS.points || []).forEach(id => safeSetFilter(id, expr));
            }


            // One change handler for all groups, debounced
            filtersRoot.addEventListener('change', (e) => {
              const container = e.target.closest('.source-card');
              if (!container) return;
              const src = container.dataset.source;
              scheduleApply(() => {
                if (src === 'waterways') applyWaterwayFilters();
                if (src === 'points') applyPointFilters();
              });
            });

            // Apply once layers are present
            function applyAllIfReady() {
              if (map.getLayer('AW Rivers-line') && map.getLayer('data-points-all')) {
                applyWaterwayFilters();
                applyPointFilters();
              }
            }
            map.on('idle', applyAllIfReady);
          };
        </script>
      </div>
    </div>
    <div id="zoom-level"></div>

  </div>
  <!-- ========================================================= -->



  <div id="combined-basemaps" style="display:none;">
    <div class="map-overlay-inner">
      <button class="close-button" onclick="closeCard()">&times;</button>

      <div class="panel-scroll">

        <div class="basemap-body">
          <div class="source-card">
            <div class="source-head">
              <div class="source-name">Basemaps</div>
            </div>
            <div class="source-controls">
              <button class="basemap-btn" data-basemap="Satellite">LINZ Satellite</button>
              <button class="basemap-btn" data-basemap="TopoLite">LINZ Topo Lite</button>
              <button class="basemap-btn" data-basemap="Topo">LINZ Topo50</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="map-overlay" id="properties"></div>

  <script>
    const styleURL = 'https://basemaps.linz.govt.nz/v1/styles/topo-raster.json?api=d01hep5551e30kxb7w85hck49tp';
    // const TODAY_UNIX = Math.floor(Date.now()/1000); // cache once per load 
    //  1760266811 -  Oct 12 2025
    const TODAY_UNIX = 1787842134
    const map = new maplibregl.Map({
      container: 'map',
      style: styleURL,
      center: [173.792725, -40.784701],
      minZoom: 5,
      zoom: 5.3
    });

    map.addControl(new maplibregl.NavigationControl({ showCompass: false }));
    map.addControl(new maplibregl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true,
      showUserHeading: true
    }));
    map.dragRotate.disable();
    map.touchZoomRotate.disableRotation();

    function openImageModal(imageUrl) {
      const modal = document.getElementById("imageModal");
      const modalImg = document.getElementById("modalImage");
      modalImg.src = imageUrl;
      modal.classList.add("show");
      modal.onclick = function (event) { if (event.target === modal) closeModal(); };
    }
    function closeModal() {
      const modal = document.getElementById("imageModal");
      modal.classList.remove("show");
      modal.onclick = null;
    }

    // Panel logic
    let activePanel = null;
    document.addEventListener('click', function (event) {
      const filtersEl = document.getElementById('combined-filters');
      const filtersBtn = document.getElementById('filter-toggle-btn');
      if (filtersEl.style.display === 'block') {
        if (!filtersEl.contains(event.target) && !filtersBtn.contains(event.target)) {
          openPanel(null);
        }
      }
    });


    function openPanel(which) {
      const cardEl = document.getElementById('properties');
      const filtersEl = document.getElementById('combined-filters');
      const basemapsEl = document.getElementById('combined-basemaps');

      // Hide all first
      cardEl.style.display = 'none';
      filtersEl.style.display = 'none';
      basemapsEl.style.display = 'none';
      activePanel = null;

      if (which === 'card') {
        cardEl.style.display = 'block';
        activePanel = 'card';
      } else if (which === 'filters') {
        filtersEl.style.display = 'block';
        activePanel = 'filters';
      } else if (which === 'basemaps') {
        basemapsEl.style.display = 'block';
        activePanel = 'basemaps';
      }
    }


    function toggleFilters(event) {
      if (activePanel === 'filters') {
        openPanel(null);
      } else {
        openPanel('filters');
      }
    }

    function toggleBasemaps(event) {
      if (activePanel === 'basemaps') {
        openPanel(null);
      } else {
        openPanel('basemaps');
      }
    }


    function normalizeUrl(raw) {
      if (!raw) return null;
      let u = String(raw).trim();
      if (!u) return null;

      // block dangerous protocols
      const lower = u.toLowerCase();
      if (lower.startsWith('javascript:') || lower.startsWith('data:')) return null;

      // add https:// if missing
      if (!/^https?:\/\//i.test(u)) u = 'https://' + u;

      try {
        const url = new URL(u);
        if (!/^https?:$/.test(url.protocol)) return null;
        return url.href;
      } catch {
        return null;
      }
    }


    const card = document.getElementById('properties');


    const riverDefaultImage = 'images/Slide12.PNG';

    const pointTypeDefaultImages = {
      'AccessPoint': 'images/Slide1.PNG',
      'TrampingAccess': 'images/Slide2.PNG',
      '4x4Access': 'images/Slide3.PNG',
      'BoatRamp': 'images/Slide4.PNG',
      'Trolling': 'images/Slide5.PNG',
      'Toilet': 'images/Slide6.PNG',
      'Jigging': 'images/Slide7.PNG',
      'FlyFishing': 'images/Slide8.PNG',
      'Warning': 'images/Slide9.PNG',
      'DOC Hut': 'images/Slide10.PNG',
      'DOC campground': 'images/Slide11.PNG',
    };

    const showCard = (feature) => {
      const props = feature.properties;
      const displayFields = {
        methods: 'Method',
        open_season: 'Open',
        daily_bag_limit: 'Daily bag limit',
        size_limit: 'Size limit',
        hours_of_fishing: 'Hours of fishing',
        description: "Description",
        additional_requirements: "Additional Requirements",
        more_info_url: "More Info",
      };

      let typeImage = null;

      // Point features
      if (feature.layer && feature.layer.id === 'data-points-all') {
        if (props.point_type && props.point_type.toLowerCase() !== 'na') {
          typeImage = pointTypeDefaultImages[props.point_type] || null;
        }
        // River features
      } else if (feature.layer && (feature.layer.id === 'AW Rivers-line' || feature.layer.id === 'AW Rivers-fill')) {
        typeImage = riverDefaultImage;
      }

      // Add any extra images from properties
      const extraImages = [props.image1, props.Image2, props.image3].filter(url => url && url.trim() !== '');
      const photoList = (typeImage ? [typeImage] : []).concat(extraImages);

      let content = `
<div class="map-overlay-inner">
  <div class="map-overlay-drag-handle"></div>
<button class="close-button" onclick="closeCard()">&times;</button>

  <div class="panel-scroll">
`;

      if (photoList.length > 0) {
        content += `
  <div class="card-image-container" style="margin-bottom: 10px;">
    <img id="cardMainImage" src="${photoList[0]}" 
      alt="Location Photo"
      onclick="openImageModal('${photoList[0]}')"
      style="width: 100%; height: 160px; object-fit: cover; object-position: center; border-radius: 6px; cursor: pointer;">
    ${photoList.length > 1 ? `
    <div class="carousel-controls" style="display: flex; justify-content: space-between; margin-top: 4px;">
      <button onclick="prevImage()" class="carousel-button">❮</button>
      <button onclick="nextImage()" class="carousel-button">❯</button>
    </div>` : ''}
  </div>
`;
      }

      content += `
  <code class="card-title">${props.Water || props.name || props.title || 'No Title'}</code>
`;
      if (props.subtitle || (typeof props.Section === 'string' && props.Section.trim() !== '')) {
        const subtitleText = props.subtitle || props.Section;
        content += `<div class="card-subtitle subtitle-main">${subtitleText}`;

        if (feature.geometry?.type === 'Point' && Array.isArray(feature.geometry.coordinates)) {
          const [lng, lat] = feature.geometry.coordinates;
          const googleMapsLink = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
          content += `
       <a href="${googleMapsLink}" target="_blank" title="Get Directions" style="font-weight: normal; text-decoration: none; color: blue;">
  (get directions)
</a>
          `;
        }
        content += `</div>`;
      }

      if (props.region || props.Region) {
        content += `<div class="card-subtitle subtitle-region">${props.Region || props.region} Fish & Game Region</div>`;
      }

      content += `<hr><ul class="card-list">`;
      for (const [key, label] of Object.entries(displayFields)) {
        const val = props[key];
        if (val === undefined || val === '') continue;

        if (key === 'more_info_url') {
          const href = normalizeUrl(val);
          if (href) {
            const host = new URL(href).hostname.replace(/^www\./, '');
            content += `<li><b>${label}</b>: <a href="${href}" target="_blank" rel="noopener noreferrer">${host}</a></li>`;
          }
        } else {
          content += `<li><b>${label}</b>: ${val}</li>`;
        }
      }

      if (props.URL1 && props.URL1.trim() !== "") {
        content += `<li><b>More Information</b>: <a href="${props.URL1}" target="_blank" rel="noopener noreferrer">Click here</a></li>`;
      }
      content += `</ul></div></div>`; /* close panel-scroll + map-overlay-inner */
      card.innerHTML = content;
      openPanel('card');

      if (photoList.length > 1) {
        window.currentPhotoIndex = 0;
        window.cardPhotoList = photoList;
        window.updateCardImage = function () {
          const img = document.getElementById('cardMainImage');
          const url = window.cardPhotoList[window.currentPhotoIndex];
          img.src = url;
          img.onclick = () => openImageModal(url);
        };
        window.prevImage = function () {
          window.currentPhotoIndex = (window.currentPhotoIndex - 1 + window.cardPhotoList.length) % window.cardPhotoList.length;
          window.updateCardImage();
        };
        window.nextImage = function () {
          window.currentPhotoIndex = (window.currentPhotoIndex + 1) % window.cardPhotoList.length;
          window.updateCardImage();
        };
      }
    };

    let selectedPoint = null;
    let selectedRiver = null;

    let selectedRiverId = null;

    function updateSelectedRiverLayers() {
      const visibleExpr = selectedRiverId == null
        ? ['==', ['id'], -1]     // hide when nothing selected
        : ['==', ['id'], selectedRiverId];

      if (map.getLayer('AW Rivers-selected-halo')) {
        map.setFilter('AW Rivers-selected-halo', visibleExpr);
      }
    }


    const customImages = [
      { name: 'AccessPoint-icon', url: 'images/FGAccess.png' },
      { name: 'TrampingAccess-icon', url: 'images/WalkingAccess.png' },
      { name: '4x4Access-icon', url: 'images/4x4Access.png' },

      { name: 'BoatRamp-icon', url: 'images/BoatRamp.png' },

      { name: 'Toilet-icon', url: 'images/Toilet.png' },

      { name: 'Warning-icon', url: 'images/Warning.png' },

      { name: 'Parking-icon', url: 'images/Parking.png' },


      { name: 'Shop-icon', url: 'images/Store.png' },
      { name: 'Lodge-icon', url: 'images/Lodge.png' },

      { name: 'FlyFishing-icon', url: 'images/Flyfishing.png' },
      { name: 'Trolling-icon', url: 'images/Trolling.png' },
      { name: 'Jigging-icon', url: 'images/Jigging.png' },

      { name: 'Hut-icon', url: 'images/DOC Hut.png' },
      { name: 'Campsite-icon', url: 'images/DOC Camp.png' },


      { name: 'BeatYR-icon', url: 'images/BeatYR.png' },
      { name: 'BeatBY-icon', url: 'images/BeatBY.png' },
      { name: 'BeatBR-icon', url: 'images/BeatBR.png' },
      { name: 'BeatR-icon', url: 'images/BeatR.png' },
    ];

    function loadCustomImages(map, callback) {
      let imagesLoaded = 0;
      customImages.forEach(({ name, url }) => {
        map.loadImage(url, (error, image) => {
          if (error) { console.error(`Error loading image "${name}" from ${url}:`, error); return; }
          if (!map.hasImage(name)) { map.addImage(name, image); }
          imagesLoaded++;
          if (imagesLoaded === customImages.length && typeof callback === 'function') callback();
        });
      });
    }

    // Prepare icon size expression (prevents initial "flash")
    let selectedFeatureId = null;
    let hoverFeatureId = null;

    function getIconSizeExpr(selectedId, hoverId) {
      return [
        'interpolate', ['linear'], ['zoom'],
        7, 0.01,
        12, [
          'case',
          // hover (but not selected)
          ['all', ['==', ['id'], hoverId ?? -1], ['!=', ['id'], selectedId ?? -2]], 0.25,
          // selected
          ['==', ['id'], selectedId ?? -2], 0.30,
          // default
          0.20
        ]
      ];
    }

    function updateIconSize() {
      if (!map.getLayer('data-points-all')) return;
      map.setLayoutProperty('data-points-all', 'icon-size', getIconSizeExpr(selectedFeatureId, hoverFeatureId));
    }

    const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    if (!isTouch) {
      // keep your existing hover handlers for points/rivers here
      // (mousemove, mouseenter, mouseleave)
    } else {
      // Ensure no hover state remains on touch
      hoverFeatureId = null;
      if (map.getLayer('data-points-all')) updateIconSize();
    }

    // Ensure images are loaded before adding layers
    map.on('styledata', () => {
      loadCustomImages(map, () => { addCustomDataAndLayers(); });
    });


    function setBasemap(type) {
      if (type === "Satellite") {
        const aerial_style = {
          "id": "st_aerial",
          "name": "aerial",
          "version": 8,
          // 🔑 Provide glyphs so text can render
          "glyphs": "https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf",
          "sources": {
            "basemaps-aerial": {
              "type": "raster",
              "tiles": [
                "https://basemaps.linz.govt.nz/v1/tiles/aerial/WebMercatorQuad/{z}/{x}/{y}.webp?api=d01hep5551e30kxb7w85hck49tp"
              ],
              "tileSize": 256,
              "attribution": "© CC BY 4.0 LINZ"
            },
            "LINZ-Terrain": {
              "type": "raster-dem",
              "tileSize": 256,
              "maxzoom": 18,
              "tiles": [
                "https://basemaps.linz.govt.nz/v1/tiles/elevation/WebMercatorQuad/{z}/{x}/{y}.png?api=d01hep5551e30kxb7w85hck49tp&pipeline=terrain-rgb"
              ]
            }
          },
          "layers": [
            { "id": "basemaps-aerial", "type": "raster", "source": "basemaps-aerial" }
          ],
          // optional, if you plan to use terrain/extrusions:
          "terrain": { "source": "LINZ-Terrain", "exaggeration": 1.0 }
        };


        map.setStyle(aerial_style);
        // map.setStyle('https://basemaps.linz.govt.nz/v1/styles/aerial.json?api=d01hep5551e30kxb7w85hck49tp');
      } else if (type === "TopoLite") {
        map.setStyle('https://basemaps.linz.govt.nz/v1/styles/topolite.json?api=d01hep5551e30kxb7w85hck49tp');
      } else if (type === "Topo") {
        const TopoStyle = {
          "id": "st_topo-raster",
          "version": 8,
          "name": "st_topo-raster",
          "metadata": { "maputnik:renderer": "mbgljs" },

          "glyphs": "https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf",

          "sources": {
            "LINZ-Elevation-Hillshade": {
              "maxzoom": 18,
              "minzoom": 0,
              "tileSize": 256,
              "tiles": [
                "https://basemaps.linz.govt.nz/v1/tiles/elevation/WebMercatorQuad/{z}/{x}/{y}.png?pipeline=terrain-rgb&api=d01hep5551e30kxb7w85hck49tp"
              ],
              "type": "raster-dem"
            },
            "LINZ-Topo-Raster": {
              "attribution": "© 2024 Toitū Te Whenua - CC BY 4.0",
              "maxzoom": 28,
              "minzoom": 0,
              "tileSize": 192,
              "tiles": [
                "https://basemaps.linz.govt.nz/v1/tiles/topo-raster/WebMercatorQuad/{z}/{x}/{y}.webp?api=d01hep5551e30kxb7w85hck49tp"
              ],
              "type": "raster"
            },
            "LINZ-Terrain": {
              "type": "raster-dem",
              "tileSize": 256,
              "maxzoom": 18,
              "tiles": [
                "https://basemaps.linz.govt.nz/v1/tiles/elevation/WebMercatorQuad/{z}/{x}/{y}.png?api=d01hep5551e30kxb7w85hck49tp&pipeline=terrain-rgb"
              ]
            }
          },

          "layers": [
            {
              "id": "Topo-Raster",
              "type": "raster",
              "source": "LINZ-Topo-Raster",
              "layout": { "visibility": "visible" }
            },
            {
              "id": "Hillshade",
              "type": "hillshade",
              "source": "LINZ-Elevation-Hillshade",
              "layout": { "visibility": "visible" },
              "paint": {
                "hillshade-accent-color": [
                  "interpolate", ["linear"], ["zoom"],
                  0, "rgb(100, 100, 100)",
                  3, "rgba(100, 100, 100, 0.400)",
                  10, "rgba(100, 100, 100, 0.333)",
                  11, "rgba(100, 100, 100, 0.267)"
                ],
                "hillshade-exaggeration": 0.4,
                "hillshade-highlight-color": [
                  "interpolate", ["linear"], ["zoom"],
                  0, "rgb(225, 229, 224)",
                  3, "rgba(225, 229, 224, 0.400)",
                  10, "rgba(225, 229, 224, 0.333)",
                  11, "rgba(225, 229, 224, 0.0667)"
                ],
                "hillshade-illumination-anchor": "map",
                "hillshade-illumination-direction": 315,
                "hillshade-shadow-color": [
                  "interpolate", ["linear"], ["zoom"],
                  0, "rgb(12, 12, 12)",
                  3, "rgba(12, 12, 12, 0.400)",
                  10, "rgba(12, 12, 12, 0.400)",
                  16, "rgba(12, 12, 12, 1.00)"
                ]
              }
            }
          ],

          "sky": {
            "atmosphere-blend": ["interpolate", ["linear"], ["zoom"], 0, 1, 10, 1, 12, 0],
            "fog-color": "#e8e8e8",
            "fog-ground-blend": 0.8,
            "horizon-color": "#ecffff",
            "horizon-fog-blend": 0.65,
            "sky-color": "#77b5fe",
            "sky-horizon-blend": 0.5
          }
        }

        map.setStyle(TopoStyle);
      }

      // Update button highlight
      document.querySelectorAll(".basemap-btn").forEach(btn => {
        btn.classList.remove("active");
        if (btn.dataset.basemap === type) {
          btn.classList.add("active");
        }
      });
    }

    // Hook up the new basemap buttons
    document.querySelectorAll(".basemap-btn").forEach(btn => {
      btn.addEventListener("click", () => setBasemap(btn.dataset.basemap));
    });

    // Default basemap selection
    window.addEventListener("load", () => {
      setBasemap("Topo");
    });


    // Legacy helper (safe no-op if container missing)
    function updateLayerFilter() {
      const container = document.getElementById('point-type-filter');
      if (!container) return;
      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      const selectedTypes = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
      const filter = ['in', ['get', 'point_type'], ['literal', selectedTypes]];
      if (map.getLayer('data-points-all')) map.setFilter('data-points-all', filter);
    }

    const clearSelection = () => {
      unselectFeatures();

      // Reset search + card UI
      const input = document.getElementById('search');
      const suggestions = document.getElementById('suggestions');
      input.value = '';
      suggestions.innerHTML = '';
      suggestions.style.display = 'none';

      card.innerHTML = '';
      card.style.display = 'none';
    };

    function closeCard() {
      unselectFeatures();   // reset both points + rivers
      openPanel(null);      // hide the panel
    }

    // make sure these exist once globally:
    // let selectedRiverId = null;
    // function updateSelectedRiverLayers(){ /* as given earlier */ }

    const selectFeature = (feature) => {
      clearSelection(); // this already unselects and hides the halo

      if (feature.layer.id === 'data-points-all') {
        selectedPoint = feature;
        map.setFeatureState({ source: 'data-points', id: feature.id }, { selected: true });

        selectedFeatureId = feature.id;
        hoverFeatureId = null;
        updateIconSize();

      } else if (feature.layer.id === 'AW Rivers-line' || feature.layer.id === 'AW Rivers-fill') {
        selectedRiver = feature;
        map.setFeatureState(
          { source: 'AW Rivers', sourceLayer: 'waterways', id: feature.id },
          { selected: true }
        );

        // NEW: drive the selected halo
        selectedRiverId = feature.id;
        updateSelectedRiverLayers();
      }

      showCard(feature);
    };

    function unselectFeatures() {
      // Clear river selection
      if (selectedRiver) {
        try {
          map.setFeatureState(
            { source: 'AW Rivers', sourceLayer: 'waterways', id: selectedRiver.id },
            { selected: false, highlight: false }
          );
        } catch (e) { }
        selectedRiver = null;
      }

      // NEW: hide the halo layer
      selectedRiverId = null;
      updateSelectedRiverLayers();

      // Clear point selection
      if (selectedPoint) {
        try {
          map.setFeatureState(
            { source: 'data-points', id: selectedPoint.id },
            { selected: false }
          );
        } catch (e) { }
        selectedPoint = null;
      }

      // Reset the ID variables that drive icon size
      selectedFeatureId = null;
      hoverFeatureId = null;
      updateIconSize();
    }


    let allFeatures = [];
    let allPointsFeatures = [];

    fetch('https://data.fishandgameaccessmap.org/secure-geojson/waterway_search_index.geojson?token=fish-access-2025').then(res => res.json()).then(data => { allFeatures = data.features; });
    fetch('https://data.fishandgameaccessmap.org/secure-geojson/AccessPoints.geojson?token=fish-access-2025')
      .then(res => res.json())
      .then(data => { allPointsFeatures = data.features; })
      .catch(err => console.error('Failed to load points data:', err));

    const zoomLevel = document.getElementById('zoom-level');
    zoomLevel.textContent = `Zoom: ${map.getZoom().toFixed(2)}`;
    map.on('zoom', () => { zoomLevel.textContent = `Zoom: ${map.getZoom().toFixed(2)}`; });

    // (Old) attach change listeners to legacy point filter — safe no-op if missing
    const legacyCheckboxes = document.querySelectorAll('#point-type-filter input[type="checkbox"]');
    legacyCheckboxes.forEach(cb => cb.addEventListener('change', updateLayerFilter));

    function addCustomDataAndLayers() {
      const sources = map.getStyle().sources;

      let firstSymbolId = null;
      let insertBeforeLayer = null;
      for (const layer of map.getStyle().layers) {
        if (!firstSymbolId && layer.type === 'symbol') firstSymbolId = layer.id;
        if (layer.id === 'Housenumber') { insertBeforeLayer = 'Poi-SportsField'; break; }
      }
      if (!insertBeforeLayer) insertBeforeLayer = firstSymbolId;


      if (!sources['PublicAccessAreas']) {
        map.addSource('PublicAccessAreas', {
          type: 'vector', tiles: ['https://data.fishandgameaccessmap.org/combined_public_access_layers/{z}/{x}/{y}'],
          minzoom: 0, maxzoom: 13
        });
      }

      
if (!map.getLayer('PublicAccessAreas-fill')) {
  map.addLayer({
    id: 'PublicAccessAreas-fill',
    type: 'fill',
    source: 'PublicAccessAreas',
    'source-layer': 'mylayer',
    minzoom: 12,
    paint: {
      'fill-color': [
        'match', ['get', 'DataType'],
        'DOC Conservation Area', '#2d6c3e',
        'Esplanade Reserve',     '#66f0cb',
        'Esplanade Strip',       '#ff66dc',
        'Hydro Parcel',          '#abecff',
        'Non-Primary Parcel',    '#ffcc66',
        'Public Access Easement','#ffd8f1',
        'Reserve Land',          '#a9cb66',
        'Road Parcel',           '#cca3e1',
        'Walkway Easement',      '#ffb2b2',
        /* default */            '#cccccc'
      ],
      'fill-opacity': [
  'interpolate', ['linear'], ['zoom'],
  12, [
    'match', ['get', 'DataType'],
    'Non-Primary Parcel', 0.10,
    /* default */           0.80
  ],
  16, [
    '*',
    [
      'match', ['get', 'DataType'],
      'Non-Primary Parcel', 0.10,
      /* default */           0.80
    ],
    0.15   // scale factor at max zoom
  ],
  20, [
    '*',
    [
      'match', ['get', 'DataType'],
      'Non-Primary Parcel', 0.10,
      /* default */           0.80
    ],
    0.15   // scale factor at max zoom
  ]
]
    }
  }, insertBeforeLayer);
}


      if (!sources['AW Rivers']) {
        map.addSource('AW Rivers', {
          type: 'vector',
          tiles: ['https://data.fishandgameaccessmap.org/all_waters/{z}/{x}/{y}'],
          minzoom: 0, maxzoom: 13
        });
      }

      if (!map.getLayer('AW Rivers-line')) {
        map.addLayer({
          id: 'AW Rivers-line',
          type: 'line',
          minzoom: 7,
          source: 'AW Rivers',
          'source-layer': 'waterways',
          layout: { 'line-join': 'round', 'line-cap': 'round' },
          paint: {
            'line-color': [
              'case',
              ['any',
                ['<', TODAY_UNIX, ['get', 'open_date_unix']],
                ['>', TODAY_UNIX, ['get', 'close_date_unix']]
              ],
              ['case',
                ['boolean', ['feature-state', 'selected'], false], '#ac261f',
                ['boolean', ['feature-state', 'highlight'], false], '#f42f58',
                '#f42f58'
              ],
              ['case',
                ['boolean', ['feature-state', 'selected'], false], '#3949ab',
                ['boolean', ['feature-state', 'highlight'], false], '#093476',
                '#0c4194'
              ]
            ],
            'line-width': [
              'case',
              ['boolean', ['feature-state', 'selected'], false], 5,
              ['boolean', ['feature-state', 'highlight'], false], 4,
              3
            ],
            'line-opacity': 1
          }
        }, insertBeforeLayer);
      }

      if (!map.getLayer('AW Rivers-fill')) {
        map.addLayer({
          id: 'AW Rivers-fill',
          type: 'fill',
          minzoom: 7,
          source: 'AW Rivers',
          'source-layer': 'waterways',
          paint: {
            'fill-color': [
              'case',
              ['any',
                ['<', TODAY_UNIX, ['get', 'open_date_unix']],
                ['>', TODAY_UNIX, ['get', 'close_date_unix']]
              ],
              ['case',
                ['boolean', ['feature-state', 'selected'], false], '#f42f58 ',
                ['boolean', ['feature-state', 'highlight'], false], '#f42f58 ',
                '#ec7983'
              ],
              ['case',
                ['boolean', ['feature-state', 'selected'], false], '#0b46a1',
                ['boolean', ['feature-state', 'highlight'], false], '#0b46a1',
                '#0F52BA'
              ]
            ],
            'fill-opacity': [
              'interpolate', ['linear'], ['zoom'],
              14, 1,
              14.01, .4
            ]
          }
        }, insertBeforeLayer);
      }

      // --- Selected-only AW Rivers stroke (wide halo only) ---

      // --- Selected-only AW Rivers stroke (wide halo only) ---
      if (!map.getLayer('AW Rivers-selected-halo')) {
        map.addLayer({
          id: 'AW Rivers-selected-halo',
          type: 'line',
          source: 'AW Rivers',
          'source-layer': 'waterways',
          minzoom: 7,
          layout: { 'line-join': 'round', 'line-cap': 'round' },
          paint: {
            'line-color': [
              'case',
              ['any',
                ['<', TODAY_UNIX, ['get', 'open_date_unix']],
                ['>', TODAY_UNIX, ['get', 'close_date_unix']]
              ],
              ['case',
                ['boolean', ['feature-state', 'selected'], false], '#ac261f',
                ['boolean', ['feature-state', 'highlight'], false], '#f42f58',
                '#f42f58'
              ],
              ['case',
                ['boolean', ['feature-state', 'selected'], false], '#002366',
                ['boolean', ['feature-state', 'highlight'], false], '#4ca6e6',
                '#4ca6e6'
              ]
            ],
            'line-width': [
              'case',
              ['boolean', ['feature-state', 'selected'], false], 5,
              ['boolean', ['feature-state', 'highlight'], false], 5,
              3
            ],
            'line-opacity': 1
          },
          // Hidden until a river is selected; filter is updated by updateSelectedRiverLayers()
          filter: ['==', ['id'], -1]
        }); // note: appended on top (no insertBeforeLayer)
      }




      if (!sources['FG Regions']) {
        map.addSource('FG Regions', {
          type: 'vector',
          tiles: ['https://data.fishandgameaccessmap.org/fg_regions/{z}/{x}/{y}'],
          minzoom: 0, maxzoom: 10
        });
      }



      if (!map.getLayer('FG Regions-line')) {
        map.addLayer({
          id: 'FG Regions-line',
          type: 'line',
          source: 'FG Regions',
          'source-layer': 'fg_regions',
          layout: { 'line-join': 'round', 'line-cap': 'round' },
          paint: { 'line-color': '#008678', 'line-width': 2, 'line-opacity': 1 }
        }, insertBeforeLayer);
      }




      if (!sources['Routes']) map.addSource('Routes', { type: 'geojson', data: 'https://data.fishandgameaccessmap.org/secure-geojson/Routes.geojson?token=fish-access-2025' });


      if (!map.getLayer('Routes-line')) {
        map.addLayer({
          id: 'Routes-line',
          type: 'line',
          source: 'Routes',
          minzoom: 9.5,
          paint: { 'line-width': ['get', 'line_width'], 'line-color': ['get', 'line_color'], 'line-dasharray': [2, 1] }
        });
      }


      // if (!sources['data-points']) {
      //   map.addSource('data-points', {
      //     type: 'geojson',
      //     data: 'AccessPoints.geojson',
      //     generateId: true
      //   });
      // }


      if (!sources['data-points']) {
        map.addSource('data-points', {
          type: 'geojson',
          data: 'https://data.fishandgameaccessmap.org/secure-geojson/AccessPoints.geojson?token=fish-access-2025',
          generateId: true
        });
      }


      if (!map.getLayer('data-points-all')) {
        map.addLayer({
          id: 'data-points-all',
          type: 'symbol',
          source: 'data-points',
          minzoom: 7,
          layout: {
            'icon-image': ['concat', ['get', 'point_type'], '-icon'],
            'icon-size': getIconSizeExpr(selectedFeatureId, hoverFeatureId), /* final expr at creation */
            'icon-anchor': ['get', 'anchor'],
            'icon-allow-overlap': true
          }
        });
      }

      if (!sources['search']) map.addSource('search', { type: 'geojson', data: 'https://data.fishandgameaccessmap.org/secure-geojson/waterway_search_index.geojson?token=fish-access-2025' });
      if (!map.getLayer('search-points-all')) {
        map.addLayer({
          id: 'search-points-all',
          type: 'circle',
          source: 'search',
          paint: { 'circle-radius': 5, 'circle-color': '#FF5733', 'circle-opacity': 0.0 }
        });
      }

      //          if (!map.getLayer('FG Regions-fill')) {
      //   map.addLayer({
      //     id: 'FG Regions-fill',
      //     type: 'fill',
      //     source: 'FG Regions',
      //     'source-layer': 'fg_regions',
      //     paint: {
      //       'fill-color': '#008678',
      //       'fill-opacity': 0.5
      //     },
      //     filter: ['in', 'RegionCode', 1,4,5,6,7,8,9,10,11,12,13] // ✅ only fills regions with these codes
      //   }, insertBeforeLayer);
      // }


      if (!sources['FG Region Centroids']) { map.addSource('FG Region Centroids', { type: 'geojson', data: 'https://data.fishandgameaccessmap.org/secure-geojson/fg_regions_centroid.geojson?token=fish-access-2025' }); }
      map.addLayer({
        id: 'FG Region Labels',
        type: 'symbol',
        source: 'FG Region Centroids',
        maxzoom: 7,
        layout: {
          'text-field': ['get', 'region'],
          'text-font': ['Noto Sans Medium'],
          // 'text-font': ['Noto Sans Medium', 'Noto Sans Regular', 'Arial Unicode MS Regular'],
          'text-size': 12,

          'text-anchor': 'center',
          'text-allow-overlap': true,
        },
        paint: {
          'text-color': '#008678',
          'text-halo-color': '#ffffff',
          'text-halo-width': 2
        }
      });

      // Wire filters
      if (window.setupAWFilters) window.setupAWFilters(map);
    }


    // Make region names clickable → zoom to their centroid
    map.on('mouseenter', 'FG Region Labels', () => { map.getCanvas().style.cursor = 'pointer'; });
    map.on('mouseleave', 'FG Region Labels', () => { map.getCanvas().style.cursor = ''; });

    map.on('click', 'FG Region Labels', (e) => {
      const f = e.features && e.features[0];
      if (!f || !f.geometry || f.geometry.type !== 'Point') return;

      const [lng, lat] = f.geometry.coordinates;

      // If a side panel is open, pad left so the name doesn't end up under it
      const leftPad = (window.activePanel === 'card' || window.activePanel === 'filters' || window.activePanel === 'basemaps')
        ? 420 : 10;

      map.easeTo({
        center: [lng, lat],
        zoom: Math.max(map.getZoom(), 8),   // target zoom when you “drill in”
        duration: 800,
        padding: { top: 80, right: 10, bottom: 10, left: leftPad }
      });
    });

    // Public access hover popup (single handler)
    const popup = document.createElement('div');
    popup.style.position = 'absolute';
    popup.style.pointerEvents = 'none';
    popup.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
    popup.style.color = '#fff';
    popup.style.fontFamily = 'Arial, sans-serif';
    popup.style.padding = '4px 8px';
    popup.style.borderRadius = '4px';
    popup.style.fontSize = '12px';
    popup.style.display = 'none';
    document.body.appendChild(popup);

    map.on('mousemove', 'PublicAccessAreas-fill', (e) => {
      const feature = e.features?.[0];
      if (feature) {
        popup.style.display = 'block';
        popup.textContent = feature.properties.DataType || 'No DataType';
        popup.style.left = e.originalEvent.pageX + 10 + 'px';
        popup.style.top = e.originalEvent.pageY + 10 + 'px';
      }
    });
    map.on('mouseleave', 'PublicAccessAreas-fill', () => { popup.style.display = 'none'; });

    // ======= Hover/selection with RAF throttling =======
    map.on('click', 'data-points-all', e => {
      selectedFeatureId = e.features[0].id;
      hoverFeatureId = null;
      updateIconSize();
    });

    // Unified click handler to prioritize points over rivers
    map.on('click', (e) => {
      const features = map.queryRenderedFeatures(e.point, {
        layers: ['data-points-all', 'AW Rivers-line', 'AW Rivers-fill']
      });
      if (features.length === 0) { clearSelection(); card.style.display = 'none'; return; }
      const pointFeature = features.find(f => f.layer.id === 'data-points-all');
      const riverFeature = features.find(f => f.layer.id === 'AW Rivers-line') || features.find(f => f.layer.id === 'AW Rivers-fill');
      if (pointFeature) selectFeature(pointFeature); else if (riverFeature) selectFeature(riverFeature);
    });

    map.on('click', (e) => {
      const features = map.queryRenderedFeatures(e.point, {
        layers: ['data-points-all'] // your point layer
      });

      if (features.length === 0) {
        // Reset selection + hover when basemap is clicked
        selectedFeatureId = null;
        hoverFeatureId = null;
        updateIconSize();
      }
    });

    let hoverDirty = false;
    map.on('mousemove', 'data-points-all', e => {
      map.getCanvas().style.cursor = 'pointer';
      const hoveredId = e.features[0].id;
      if (hoveredId !== selectedFeatureId && hoveredId !== hoverFeatureId) {
        hoverFeatureId = hoveredId;
        if (!hoverDirty) {
          hoverDirty = true;
          requestAnimationFrame(() => { hoverDirty = false; updateIconSize(); });
        }
      }
    });
    map.on('mouseleave', 'data-points-all', () => {
      map.getCanvas().style.cursor = '';
      if (hoverFeatureId !== null) {
        hoverFeatureId = null;
        requestAnimationFrame(updateIconSize);
      }
    });

    let hoveredRiverId = null;
    let hoveringLayers = new Set();
    function updateCursor() {
      map.getCanvas().style.cursor = (hoveringLayers.size > 0) ? 'pointer' : '';
    }

    // Throttled river hover (shared for line+fill)
    let nextHoverId = null, hoverScheduled = false;
    function setRiverHover(id) {
      nextHoverId = id;
      if (hoverScheduled) return;
      hoverScheduled = true;
      requestAnimationFrame(() => {
        hoverScheduled = false;
        if (hoveredRiverId !== nextHoverId) {
          if (hoveredRiverId != null) {
            map.setFeatureState({ source: 'AW Rivers', sourceLayer: 'waterways', id: hoveredRiverId }, { highlight: false });
          }
          hoveredRiverId = nextHoverId;
          if (hoveredRiverId != null) {
            map.setFeatureState({ source: 'AW Rivers', sourceLayer: 'waterways', id: hoveredRiverId }, { highlight: true });
          }
        }
      });
    }

    map.on('mouseenter', 'AW Rivers-line', () => { hoveringLayers.add('line'); updateCursor(); });
    map.on('mouseleave', 'AW Rivers-line', () => { hoveringLayers.delete('line'); updateCursor(); if (hoveringLayers.size === 0) setRiverHover(null); });
    map.on('mousemove', 'AW Rivers-line', (e) => { const f = e.features?.[0]; setRiverHover(f ? f.id : null); });

    map.on('mouseenter', 'AW Rivers-fill', () => { hoveringLayers.add('fill'); updateCursor(); });
    map.on('mouseleave', 'AW Rivers-fill', () => { hoveringLayers.delete('fill'); updateCursor(); if (hoveringLayers.size === 0) setRiverHover(null); });
    map.on('mousemove', 'AW Rivers-fill', (e) => { const f = e.features?.[0]; setRiverHover(f ? f.id : null); });

    // Search (unchanged logic; could be debounced later if needed)
    const inputEl = document.getElementById('search');
    const suggestions = document.getElementById('suggestions');
    inputEl.addEventListener('input', () => {
      const query = inputEl.value.trim().toLowerCase();
      suggestions.innerHTML = '';
      if (!query) { suggestions.style.display = 'none'; return; }

      const riverMatches = allFeatures.filter(f => f.properties.Water.toLowerCase().includes(query));
      const pointMatches = allPointsFeatures.filter(f => f.properties.title && f.properties.title.toLowerCase().includes(query));

      if (riverMatches.length) {
        const header = document.createElement('div');
        header.className = 'suggestion-header river-header';
        header.innerHTML = `<span>WATERWAYS</span>`;
        suggestions.appendChild(header);
        riverMatches.forEach(f => {
          const div = document.createElement('div');
          div.className = 'suggestion river';
          div.innerHTML = `
            <strong>${f.properties.Water}</strong><br>
            ${typeof f.properties.Section === 'string' && f.properties.Section ? `<div class="section">${f.properties.Section}</div>` : ''}
            <div class="region">${f.properties.Region || ''}</div>`;
          div.style.cursor = 'pointer';
          div.onclick = () => selectFeatureFromSearch(f);
          suggestions.appendChild(div);
        });
      }

      if (pointMatches.length) {
        const header = document.createElement('div');
        header.className = 'suggestion-header point-header';
        header.innerHTML = `<span> ACCESS POINTS</span>`;
        suggestions.appendChild(header);
        pointMatches.forEach(f => {
          const div = document.createElement('div');
          div.className = 'suggestion point';
          div.innerHTML = `
            <strong>${f.properties.title}</strong><br>
            <div class="region">${f.properties.Region || ''}</div>`;
          div.style.cursor = 'pointer';
          div.onclick = () => selectFeatureFromSearch(f);
          suggestions.appendChild(div);
        });
      }

      suggestions.style.display = (riverMatches.length || pointMatches.length) ? 'block' : 'none';
    });

    function selectFeatureFromSearch(f) {
      const coords = f.geometry.coordinates;
      clearSelection();
      map.flyTo({ center: coords, zoom: 12 });

      const isRiver = f.properties.Water !== undefined;
      inputEl.value = isRiver ? f.properties.Water : f.properties.title;
      suggestions.style.display = 'none';
      showCard(f);

      if (isRiver) {
        map.setFilter('AW Rivers-line', null);
        map.setFilter('AW Rivers-fill', null);
        map.setFeatureState({ source: 'AW Rivers', sourceLayer: 'waterways', id: f.id }, { selected: true });
        selectedRiver = { id: f.id };
      } else {
        selectedFeatureId = f.id;
        hoverFeatureId = null;
        updateIconSize();
        selectedPoint = { id: f.id };
      }
    }

    // Initialize filter wiring now that the map object exists
    if (window.setupAWFilters) window.setupAWFilters(map);
    // Expose TODAY_UNIX to filter script
    window.__TODAY_UNIX__ = TODAY_UNIX;
  </script>

</body>

</html>